version: 0.2

phases:
  install:
    commands:
      - echo "Installing yamllint..."
      - pip3 install yamllint

  pre_build:
    commands:
      - echo "Linting buildspec.yml..."
      - yamllint -c .yamllint martini-build-image.yaml || echo "YAML lint warnings found (non-blocking)"

      - echo "Fetching environment variables from Parameter Store..."
      - 'PARAMETER_NAME=${PARAMETER_NAME:-martini-build-image}'
      - 'echo "Using Parameter Store key: ${PARAMETER_NAME}"'

      - PARAMETER=$(aws ssm get-parameter --name "${PARAMETER_NAME}" --with-decryption --query "Parameter.Value" --output text)
      - export MARTINI_VERSION=$(echo "$PARAMETER" | jq -r '.MARTINI_VERSION')
      - export ECR_REPO_NAME=$(echo "$PARAMETER" | jq -r '.ECR_REPO_NAME')

      # Dynamically detect the region based on CodeBuild runtime metadata
      - export AWS_REGION=$(curl -s http://169.254.169.254/latest/dynamic/instance-identity/document | grep region | awk -F\" '{print $4}')
      - export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query "Account" --output text)

      # Debug output
      - echo "Resolved AWS_REGION=$AWS_REGION"
      - echo "Resolved AWS_ACCOUNT_ID=$AWS_ACCOUNT_ID"
      - echo "Resolved ECR_REPO_NAME=$ECR_REPO_NAME"
      - echo "Resolved MARTINI_VERSION=$MARTINI_VERSION"

      # Fail fast if any required variable is missing
      - if [ -z "$AWS_REGION" ] || [ -z "$AWS_ACCOUNT_ID" ] || [ -z "$ECR_REPO_NAME" ] || [ -z "$MARTINI_VERSION" ]; then echo "‚ùå Missing required environment variables."; exit 1; fi

  build:
    commands:
      - echo "Building Docker image for Martini version ${MARTINI_VERSION}..."
      - docker build --build-arg MARTINI_VERSION="${MARTINI_VERSION}" -t mr:"${MARTINI_VERSION}" .

      - echo "Authenticating with AWS ECR..."
      - aws ecr get-login-password --region "$AWS_REGION" | docker login --username AWS --password-stdin "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"

      - echo "Tagging image..."
      - docker tag mr:"${MARTINI_VERSION}" "${ECR_REPO_URI}:${MARTINI_VERSION}"

  post_build:
    commands:
      - echo "Pushing image to ECR..."
      - docker push "${ECR_REPO_URI}:${MARTINI_VERSION}"

artifacts:
  files:
    - '**/*'
  discard-paths: true
