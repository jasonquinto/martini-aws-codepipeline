version: 0.2

phases:
  install:
    commands:
      - # Install dependencies if needed
      - yum update -y
      - yum install -y amazon-linux-extras
      - amazon-linux-extras enable epel
      - yum install -y epel-release
      - yum install -y ShellCheck python3-pip
      - pip3 install shfmt yamllint

  pre_build:
    commands:
      - echo "Running shell and YAML lint checks..."
      - shellcheck upload_packages.sh
      - shfmt -d upload_packages.sh
      - yamllint buildspec.yml
      - echo "Fetching and exporting SSM parameters"
      - PARAMETER=$(aws ssm get-parameter --name "martini-upload-package" --with-decryption --query "Parameter.Value" --output text)
      - export BASE_URL=$(echo "$PARAMETER" | jq -r '.BASE_URL')
      - export MARTINI_ACCESS_TOKEN=$(echo "$PARAMETER" | jq -r '.MARTINI_ACCESS_TOKEN')
      - export PACKAGE_NAME_PATTERN=$(echo "$PARAMETER" | jq -r '.PACKAGE_NAME_PATTERN // ".*"')
      - export PACKAGE_DIR=$(echo "$PARAMETER" | jq -r '.PACKAGE_DIR // "packages"')
      - export ASYNC_UPLOAD=$(echo "$PARAMETER" | jq -r '.ASYNC_UPLOAD // "false"')
      - export SUCCESS_CHECK_TIMEOUT=$(echo "$PARAMETER" | jq -r '.SUCCESS_CHECK_TIMEOUT // 6')
      - export SUCCESS_CHECK_DELAY=$(echo "$PARAMETER" | jq -r '.SUCCESS_CHECK_DELAY // 30')
      - export SUCCESS_CHECK_PACKAGE_NAME=$(echo "$PARAMETER" | jq -r '.SUCCESS_CHECK_PACKAGE_NAME // ""')

  build:
    commands:
      - chmod +x upload_packages.sh
      - ./upload_packages.sh

artifacts:
  files:
    - '**/packages.zip'
    - '**/response_body.log'
    - '**/results.log'
  discard-paths: yes
